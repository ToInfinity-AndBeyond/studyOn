default_platform(:ios)

platform :ios do
  desc "Build an unsigned xcarchive"
  lane :build_unsigned_xcarchive do
    gym(
      configuration: "Release",
      project: "StudyOn.xcodeproj",
      output_directory: "./output/archive",
      archive_path: "./output/archive/StudyOn.xcarchive",
      export_method: "ad-hoc",  # This is required, but won't affect since we're not exporting an IPA
      skip_codesigning: true,
      skip_package_ipa: true,
      export_options: {
        compileBitcode: false,
        method: "ad-hoc",
        signingStyle: "manual",
        provisioningProfiles: {},
        signingCertificate: "",
        teamID: "",
        uploadSymbols: false,
        stripSwiftSymbols: true,
        thinning: "<none>",
        iCloudContainerEnvironment: "Production"
      }
    )
    sh "echo 'Contents of output/archive after build:' && ls -R ./output/archive"
  end

  desc "Create unsigned IPA from xcarchive"
  lane :create_unsigned_ipa do
    archive_path = "./output/archive/StudyOn.xcarchive"
    ipa_output_path = "./output/ipa"
    sh "mkdir -p #{ipa_output_path}/Payload"
    sh "echo 'Contents of #{archive_path}:' && ls -R #{archive_path}"

    # Ensure the .app directory exists
    app_path = "#{archive_path}/Products/Applications/StudyOn.app"
    unless File.directory?(app_path)
      UI.user_error!("App bundle not found at #{app_path}")
    end

    sh "cp -R #{app_path} #{ipa_output_path}/Payload/StudyOn.app"
    sh "cd #{ipa_output_path} && zip -r StudyOn.ipa Payload"
  end
end
