default_platform(:ios)

platform :ios do
  desc "Run unit tests"
  lane :unit_tests do
    clean_derived_data
    shutdown_simulator
    reset_simulator
    run_tests(
      scheme: "StudyOn",
      device: "iPhone SE (3rd generation)",
      clean: true
    )
  end

  desc "Build an unsigned xcarchive"
  lane :build_unsigned_xcarchive do
    gym(
      configuration: "Release",
      project: "StudyOn.xcodeproj",
      output_directory: "./output/archive",
      archive_path: "./output/archive/StudyOn.xcarchive",
      export_method: "ad-hoc",  # This is required, but won't affect since we're not exporting an IPA
      skip_codesigning: true,
      skip_package_ipa: true,
      export_options: {
        compileBitcode: false,
        method: "ad-hoc",
        signingStyle: "manual",
        provisioningProfiles: {},
        signingCertificate: "",
        teamID: "",
        uploadSymbols: false,
        stripSwiftSymbols: true,
        thinning: "<none>",
        iCloudContainerEnvironment: "Production"
      }
    )
  end

  private_lane :shutdown_simulator do
    sh("xcrun simctl shutdown all")
  end

  private_lane :reset_simulator do
    sh("xcrun simctl erase all")
  end

  private_lane :clean_derived_data do
    sh("rm -rf ~/Library/Developer/Xcode/DerivedData/*")
  end
end
